<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Connection Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Courier New', monospace;
      background: #0a0015;
      color: #00f6ff;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(0, 246, 255, 0.05);
      border: 1px solid rgba(0, 246, 255, 0.3);
      border-radius: 8px;
      padding: 20px;
    }
    h1 {
      color: #00f6ff;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(0, 246, 255, 0.5);
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #00f6ff;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 246, 255, 0.3);
      border-radius: 4px;
      color: #00f6ff;
      font-family: 'Courier New', monospace;
    }
    button {
      padding: 10px 20px;
      background: #00f6ff;
      color: #0a0015;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #00d9e6;
      box-shadow: 0 0 10px rgba(0, 246, 255, 0.5);
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .status.connected {
      background: rgba(0, 255, 157, 0.2);
      border: 1px solid #00ff9d;
      color: #00ff9d;
    }
    .status.disconnected {
      background: rgba(255, 0, 170, 0.2);
      border: 1px solid #ff00aa;
      color: #ff00aa;
    }
    .status.connecting {
      background: rgba(157, 0, 255, 0.2);
      border: 1px solid #9d00ff;
      color: #9d00ff;
    }
    .log {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(0, 246, 255, 0.3);
      border-radius: 4px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin-bottom: 8px;
      padding: 5px;
      border-left: 3px solid;
    }
    .log-entry.info {
      border-color: #00f6ff;
      color: #00f6ff;
    }
    .log-entry.success {
      border-color: #00ff9d;
      color: #00ff9d;
    }
    .log-entry.error {
      border-color: #ff00aa;
      color: #ff00aa;
    }
    .log-entry.warning {
      border-color: #9d00ff;
      color: #9d00ff;
    }
    .timestamp {
      color: #666;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”Œ WebSocket Connection Test</h1>
    
    <div class="input-group">
      <label for="wsUrl">WebSocket URL:</label>
      <input 
        type="text" 
        id="wsUrl" 
        value="wss://pokerbackend-production-17fd.up.railway.app/ws"
        placeholder="wss://your-backend.up.railway.app/ws"
      >
    </div>
    
    <div class="input-group">
      <label for="roomId">Room ID (optional, for testing):</label>
      <input 
        type="text" 
        id="roomId" 
        value=""
        placeholder="Enter room ID to test HELLO message"
      >
    </div>
    
    <div class="input-group">
      <label for="accessToken">Access Token (optional, for HELLO):</label>
      <input 
        type="text" 
        id="accessToken" 
        value=""
        placeholder="Enter Supabase access token for HELLO message"
      >
    </div>
    
    <div>
      <button id="connectBtn" onclick="connect()">Connect</button>
      <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
      <button onclick="sendPing()" id="pingBtn" disabled>Send PING</button>
      <button onclick="sendHello()" id="helloBtn" disabled>Send HELLO</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="status" class="status disconnected">
      Status: Disconnected
    </div>
    
    <div class="log" id="log"></div>
  </div>

  <script>
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 3;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      
      const timestamp = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
      
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function updateStatus(status, text) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${status}`;
      statusDiv.textContent = `Status: ${text}`;
    }

    function updateButtons(connected) {
      document.getElementById('connectBtn').disabled = connected;
      document.getElementById('disconnectBtn').disabled = !connected;
      document.getElementById('pingBtn').disabled = !connected;
      document.getElementById('helloBtn').disabled = !connected;
    }

    function connect() {
      const wsUrl = document.getElementById('wsUrl').value.trim();
      
      if (!wsUrl) {
        log('Please enter a WebSocket URL', 'error');
        return;
      }

      if (ws && ws.readyState === WebSocket.OPEN) {
        log('Already connected', 'warning');
        return;
      }

      log(`Connecting to: ${wsUrl}`, 'info');
      updateStatus('connecting', 'Connecting...');
      updateButtons(false);

      try {
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          log('âœ… WebSocket connection opened successfully!', 'success');
          updateStatus('connected', 'Connected');
          updateButtons(true);
          reconnectAttempts = 0;
        };

        ws.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            log(`ðŸ“¨ Received: ${JSON.stringify(message, null, 2)}`, 'success');
          } catch (e) {
            log(`ðŸ“¨ Received (raw): ${event.data}`, 'info');
          }
        };

        ws.onerror = (error) => {
          log(`âŒ WebSocket error: ${error.message || 'Unknown error'}`, 'error');
          updateStatus('disconnected', 'Error');
        };

        ws.onclose = (event) => {
          log(`ðŸ”Œ WebSocket closed. Code: ${event.code}, Reason: ${event.reason || 'None'}, Clean: ${event.wasClean}`, 'warning');
          updateStatus('disconnected', 'Disconnected');
          updateButtons(false);
          ws = null;

          // Auto-reconnect on unexpected close
          if (!event.wasClean && reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`, 'info');
            setTimeout(connect, 2000);
          }
        };
      } catch (error) {
        log(`âŒ Failed to create WebSocket: ${error.message}`, 'error');
        updateStatus('disconnected', 'Error');
        updateButtons(false);
      }
    }

    function disconnect() {
      if (ws) {
        ws.close(1000, 'User disconnected');
        ws = null;
      }
      updateStatus('disconnected', 'Disconnected');
      updateButtons(false);
    }

    function sendPing() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('Cannot send PING: WebSocket not connected', 'error');
        return;
      }

      const message = { type: 'PING' };
      ws.send(JSON.stringify(message));
      log(`ðŸ“¤ Sent: ${JSON.stringify(message)}`, 'info');
    }

    function sendHello() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('Cannot send HELLO: WebSocket not connected', 'error');
        return;
      }

      const roomId = document.getElementById('roomId').value.trim();
      const accessToken = document.getElementById('accessToken').value.trim();

      if (!roomId || !accessToken) {
        log('Please enter both Room ID and Access Token to send HELLO', 'warning');
        return;
      }

      const message = {
        type: 'HELLO',
        roomId: roomId,
        accessToken: accessToken
      };

      ws.send(JSON.stringify(message));
      log(`ðŸ“¤ Sent: ${JSON.stringify(message)}`, 'info');
    }

    // Test connection on page load if URL is set
    window.addEventListener('load', () => {
      const wsUrl = document.getElementById('wsUrl').value.trim();
      if (wsUrl) {
        log('Page loaded. Click "Connect" to test WebSocket connection.', 'info');
      }
    });
  </script>
</body>
</html>
