(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[684],{2749:function(e,r,t){Promise.resolve().then(t.bind(t,7948))},7948:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return L}});var n=t(7437),a=t(2265),s=t(6994),l=t(4687),i=t(257);let o="https://watbrrrtsruvotjisvkp.supabase.co",c="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhdGJycnJ0c3J1dm90amlzdmtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Njc0NDQsImV4cCI6MjA4MTQ0MzQ0NH0.s3n81p9aX5cyWbOuPwoKjqLOW7X2nuJQBtxGz1sV3eQ";if(!o||!c)throw console.error("Missing Supabase environment variables:",{hasNextPublicUrl:!0,hasViteUrl:!!i.env.VITE_SUPABASE_URL,hasNextPublicKey:!0,hasViteKey:!!i.env.VITE_SUPABASE_ANON_KEY}),Error("Missing Supabase environment variables. Please check your .env.local file.");let d=(0,l.AY)(o,c),u=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t]},m=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t]},y=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];console.error(...r)},p=()=>{let e="ws:localhost:4000/ws";if(!e)throw Error("NEXT_PUBLIC_GAME_SERVER_WS_URL or VITE_GAME_SERVER_WS_URL environment variable is not set");return e};function f(e){let r;return"object"!=typeof e||null===e?{suit:"S",rank:"3"}:("number"==typeof e.suit?r=({0:"S",1:"H",2:"C",3:"D"})[e.suit]||"S":"string"==typeof e.suit&&["S","H","C","D"].includes(r=({"♠":"S","♥":"H","♣":"C","♦":"D"})[e.suit]||e.suit)||(r="S"),{suit:r,rank:"number"==typeof e.rank?({3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9",10:"10",11:"J",12:"Q",13:"K",14:"A",15:"2"})[e.rank]||"3":"string"==typeof e.rank&&["3","4","5","6","7","8","9","10","J","Q","K","A","2"].includes(e.rank)?e.rank:"3"})}function g(e){return({3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,J:11,Q:12,K:13,A:14,2:15})[e]||0}function x(e){return({D:0,C:1,H:2,S:3})[e]||0}function h(e){return[...e].sort((e,r)=>{let t=g(e.rank)-g(r.rank);return 0!==t?t:x(e.suit)-x(r.suit)})}function v(e,r){return e.rank===r.rank&&e.suit===r.suit}function b(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return r.filter(Boolean).join(" ")}function S(e){let{className:r,variant:t="default",size:a="md",children:s,...l}=e;return(0,n.jsx)("span",{className:b("inline-flex items-center font-semibold rounded-md backdrop-blur-sm",{default:"glass border border-cyan-400/40 text-cyan-300",primary:"bg-cyan-900/50 border border-cyan-400/60 text-cyan-300 shadow-neon-cyan",success:"bg-lime-900/50 border border-lime-400/60 text-lime-300 shadow-neon-lime",danger:"bg-pink-900/50 border border-pink-400/60 text-pink-300 shadow-neon-magenta",warning:"bg-purple-900/50 border border-purple-400/60 text-purple-300 shadow-neon-purple",info:"bg-cyan-900/50 border border-cyan-400/60 text-cyan-300 shadow-neon-cyan"}[t],{sm:"px-2 py-0.5 text-xs font-heading",md:"px-2.5 py-1 text-sm font-heading"}[a],r),...l,children:s})}let N=(0,a.memo)(function(e){let{playerId:r,playerName:t,playerAvatar:a,cardsLeft:s,totalScore:l,scoreLimit:i,isCurrentTurn:o,isEliminated:c,isYou:d}=e,u=r.length>8?r.substring(0,8)+"...":r,m=t||u,y=m.trim().charAt(0).toUpperCase()||"?",p=l/i*100;return(0,n.jsxs)("div",{className:b("relative glass rounded-xl border-2 text-center transition-all duration-300","hover:scale-105 hover:shadow-glow-cyan","w-36 p-4",o?"border-cyan-400 shadow-glow-cyan ring-2 ring-cyan-400/50 animate-pulse-glow":"border-cyan-500/30",c&&"opacity-50 border-pink-500/50 bg-pink-900/20",d&&!o&&"border-lime-400/40"),children:[(0,n.jsx)("div",{className:"relative mb-3",children:(0,n.jsxs)("div",{className:b("w-16 h-16 mx-auto rounded-full border-2 flex items-center justify-center overflow-hidden","glass-lg",o?"border-cyan-400 shadow-glow-cyan":d?"border-lime-400/60 shadow-neon-lime":"border-cyan-500/40",c&&"border-pink-500/50"),children:[a?(0,n.jsx)("img",{src:a,alt:m,className:"w-full h-full object-cover",onError:e=>{let r=e.target;r.style.display="none";let t=r.parentElement;t&&(t.innerHTML='<div class="w-full h-full flex items-center justify-center '.concat(o?"text-cyan-300 text-glow-cyan":"text-cyan-400"," ").concat(c?"text-pink-400":"",' text-2xl font-bold font-heading">').concat(y,"</div>"))}}):(0,n.jsx)("div",{className:b("text-2xl font-bold font-heading",o?"text-cyan-300 text-glow-cyan":"text-cyan-400",c&&"text-pink-400"),children:y}),o&&(0,n.jsx)("div",{className:"absolute inset-0 rounded-full border-2 border-cyan-400 animate-ping opacity-75"})]})}),(0,n.jsxs)("div",{className:"font-heading font-semibold text-sm mb-2",children:[(0,n.jsx)("div",{className:b("truncate",o?"text-cyan-300 text-glow-cyan":"text-white",c&&"text-pink-400"),children:m}),d&&(0,n.jsx)("span",{className:"ml-1 text-xs text-lime-400 text-glow-lime font-medium",children:"(YOU)"})]}),(0,n.jsxs)("div",{className:"space-y-2 text-xs",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("span",{className:"text-cyan-400/80",children:"Cards:"}),(0,n.jsx)("span",{className:"font-bold text-cyan-300",children:s})]}),(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between text-xs",children:[(0,n.jsx)("span",{className:"text-cyan-400/80",children:"Score:"}),(0,n.jsxs)("span",{className:b("font-bold",p>=80?"text-pink-400":p>=50?"text-yellow-400":"text-lime-400"),children:[l," / ",i]})]}),(0,n.jsx)("div",{className:"h-1.5 bg-cyan-900/30 rounded-full overflow-hidden",children:(0,n.jsx)("div",{className:b("h-full transition-all duration-300 rounded-full",p>=80?"bg-gradient-to-r from-pink-500 to-pink-600 shadow-neon-magenta":p>=50?"bg-gradient-to-r from-yellow-400 to-yellow-500":"bg-gradient-to-r from-lime-400 to-lime-500 shadow-neon-lime"),style:{width:"".concat(Math.min(p,100),"%")}})})]})]}),o&&(0,n.jsx)(S,{variant:"warning",size:"sm",className:"absolute -top-2 -right-2 shadow-lg border-cyan-400 bg-cyan-900/50 text-cyan-300 font-heading",children:"TURN"}),c&&(0,n.jsx)(S,{variant:"danger",size:"sm",className:"absolute -top-2 -left-2 shadow-lg border-pink-400 bg-pink-900/50 text-pink-300 font-heading",children:"ELIM"})]})}),j={S:"text-black",H:"text-red-600",C:"text-black",D:"text-red-600"},w=(0,a.memo)(function(e){let{card:r,isSelected:t=!1,onClick:a,size:s="md",className:l,isBack:i=!1}=e,o={sm:"w-12 h-16 text-xs",md:"w-16 h-24 text-sm",lg:"w-20 h-32 text-base"},c={S:"♠",H:"♥",C:"♣",D:"♦"}[r.suit],d=j[r.suit]||"text-black";return i?(0,n.jsxs)("div",{className:b("relative bg-white rounded-lg border-2 border-gray-300 cursor-pointer transition-all duration-300","hover:scale-110 hover:border-gray-400",o[s],l),onClick:a,children:[(0,n.jsx)("div",{className:"absolute inset-0 opacity-10",children:(0,n.jsx)("div",{className:"absolute inset-0",style:{backgroundImage:"\n              repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.1) 2px, rgba(0, 0, 0, 0.1) 4px),\n              repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 0, 0, 0.1) 2px, rgba(0, 0, 0, 0.1) 4px)\n            "}})}),(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,n.jsx)("div",{className:"text-black text-2xl font-bold",children:"♠"})})]}):(0,n.jsx)("div",{className:b("relative bg-white rounded-lg border-2 border-gray-300 transition-all duration-300 cursor-pointer","hover:scale-110 hover:-translate-y-2 hover:border-gray-400 hover:shadow-xl",t?"scale-110 -translate-y-2 border-blue-500 ring-2 ring-blue-400/50 shadow-xl":"hover:border-gray-400",o[s],l),onClick:a,children:(0,n.jsxs)("div",{className:"absolute inset-0 p-2 flex flex-col justify-between",children:[(0,n.jsx)("div",{className:b("font-bold",d),children:(0,n.jsx)("div",{className:"leading-tight",children:r.rank})}),(0,n.jsx)("div",{className:b("absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl",d),children:c}),(0,n.jsx)("div",{className:b("font-bold self-end rotate-180",d),children:(0,n.jsx)("div",{className:"leading-tight",children:r.rank})})]})})}),E=(0,a.memo)(function(e){let{seatedPlayerIds:r,handsCount:t,totalScores:s,scoreLimit:l,currentTurnPlayerId:i,eliminated:o,currentUserId:c,lastPlay:d,playerNames:u,playerAvatars:m}=e,y=r.length,p=(0,a.useMemo)(()=>0===y?[]:r.map((e,r)=>{let t=Math.PI/180*(270+360*r/y);return{x:250+200*Math.cos(t),y:250+200*Math.sin(t),angle:180/Math.PI*t}}),[r,y]);if(0===y)return null;let g=e=>p[e];return(0,n.jsx)("div",{className:"flex justify-center items-center p-6 min-h-[600px] relative",children:(0,n.jsxs)("div",{className:"relative w-[500px] h-[500px]",children:[(0,n.jsxs)("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[400px] h-[400px] rounded-full",children:[(0,n.jsx)("div",{className:"absolute inset-0 rounded-full bg-gradient-to-br from-purple-900/20 via-cyan-900/20 to-pink-900/20 animate-pulse-glow"}),(0,n.jsxs)("div",{className:"absolute inset-2 rounded-full",style:{background:"radial-gradient(circle at 30% 30%, rgba(157, 0, 255, 0.3) 0%, rgba(10, 0, 21, 0.9) 50%, #0a0015 100%)",border:"2px solid rgba(0, 246, 255, 0.3)"},children:[(0,n.jsx)("div",{className:"absolute inset-0 rounded-full border-2 border-cyan-400/40 shadow-[0_0_20px_rgba(0,246,255,0.3)]"}),(0,n.jsx)("div",{className:"absolute inset-0 rounded-full opacity-10",style:{backgroundImage:"\n                  repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(0, 246, 255, 0.1) 20px, rgba(0, 246, 255, 0.1) 21px),\n                  repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(0, 246, 255, 0.1) 20px, rgba(0, 246, 255, 0.1) 21px)\n                "}})]}),(0,n.jsx)("div",{className:"absolute inset-0 rounded-full border-4 border-cyan-400/60 shadow-[0_0_30px_rgba(0,246,255,0.5),inset_0_0_30px_rgba(0,246,255,0.2)] animate-glow-pulse"})]}),d&&(0,n.jsxs)("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20 glass-lg rounded-xl border border-cyan-400/50 p-4 min-w-[200px] text-center shadow-glow-cyan",children:[(0,n.jsx)("div",{className:"text-xs text-cyan-400/80 mb-2 font-heading uppercase tracking-wider",children:"Last Play"}),(0,n.jsx)("div",{className:"text-sm font-bold text-cyan-300 mb-3 font-heading text-glow-cyan",children:(()=>{let e=d.cards.length,r=d.kind;return(r||(r=1===e?"SINGLE":2===e?"PAIR":3===e?"SET":5===e?"FIVE":"PLAY"),"FIVE"===r&&d.fiveKind)?"".concat(r," (").concat(d.fiveKind,")"):r})()}),(0,n.jsx)("div",{className:"flex gap-2 justify-center flex-wrap",children:d.cards.map((e,r)=>{let t=f(e);return(0,n.jsx)(w,{card:t,size:"sm",className:"pointer-events-none"},r)})})]}),r.map((e,r)=>{let a=g(r);return(0,n.jsx)("div",{className:"absolute z-10",style:{left:"".concat(a.x,"px"),top:"".concat(a.y,"px"),transform:"translate(-50%, -50%)"},children:(0,n.jsx)(N,{playerId:e,playerName:null==u?void 0:u[e],playerAvatar:(null==m?void 0:m[e])||null,cardsLeft:t[e]||0,totalScore:s[e]||0,scoreLimit:l,isCurrentTurn:e===i,isEliminated:o.includes(e),isYou:e===c})},e)})]})})});function R(e){let{className:r,header:t,footer:a,children:s,...l}=e;return(0,n.jsxs)("div",{className:b("glass rounded-xl border border-white/10","hover:border-cyan-400/30 hover:bg-white/5 transition-all duration-200",r),...l,children:[t&&(0,n.jsx)("div",{className:"px-6 py-4 border-b border-white/10",children:t}),(0,n.jsx)("div",{className:b(t||a?"px-6 py-4":"p-6"),children:s}),a&&(0,n.jsx)("div",{className:"px-6 py-4 border-t border-white/10",children:a})]})}function _(e){let{queuePlayerIds:r,seatedPlayerIds:t,handsCount:a,totalScores:s,scoreLimit:l,currentTurnPlayerId:i,eliminated:o,playerNames:c}=e,d=e=>e.length>6?e.substring(0,6)+"...":e,u=e=>(null==c?void 0:c[e])||d(e);return(0,n.jsx)(R,{className:"w-full max-w-sm",children:(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-[var(--text)] mb-3",children:"Queue"}),0===r.length?(0,n.jsx)("p",{className:"text-sm text-[var(--text-muted)] italic",children:"No players in queue"}):(0,n.jsx)("div",{className:"space-y-2",children:r.map((e,r)=>(0,n.jsxs)("div",{className:b("flex items-center gap-3 p-3 rounded-lg border border-[var(--border)]","bg-[var(--bg-elevated)] hover:bg-[var(--surface-hover)] transition-colors"),children:[(0,n.jsxs)("span",{className:"text-sm font-semibold text-[var(--text-muted)] w-6",children:[r+1,"."]}),(0,n.jsx)("span",{className:"flex-1 text-sm text-[var(--text)] font-medium",children:u(e)}),(0,n.jsxs)("span",{className:"text-xs text-[var(--text-muted)]",children:[s[e]||0," / ",l]}),o.includes(e)&&(0,n.jsx)(S,{variant:"danger",size:"sm",children:"ELIM"})]},e))})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-[var(--text)] mb-3",children:"Seated Scores"}),0===t.length?(0,n.jsx)("p",{className:"text-sm text-[var(--text-muted)] italic",children:"No players seated"}):(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsxs)("div",{className:"grid grid-cols-[2fr_1fr_1.5fr_1fr] gap-3 px-3 py-2 bg-[var(--bg-elevated)] rounded-lg text-xs font-semibold text-[var(--text-muted)]",children:[(0,n.jsx)("div",{children:"Player"}),(0,n.jsx)("div",{children:"Cards"}),(0,n.jsx)("div",{children:"Score"}),(0,n.jsx)("div",{children:"Turn"})]}),t.map(e=>(0,n.jsxs)("div",{className:b("grid grid-cols-[2fr_1fr_1.5fr_1fr] gap-3 px-3 py-2 rounded-lg","border border-[var(--border)] bg-[var(--bg-elevated)]","hover:bg-[var(--surface-hover)] transition-colors",o.includes(e)&&"opacity-60 bg-[var(--danger-bg)]"),children:[(0,n.jsx)("div",{className:"text-sm text-[var(--text)] font-medium truncate",children:u(e)}),(0,n.jsx)("div",{className:"text-sm text-[var(--text-muted)]",children:a[e]||0}),(0,n.jsxs)("div",{className:"text-sm text-[var(--text-muted)]",children:[s[e]||0," / ",l]}),(0,n.jsx)("div",{className:"flex items-center",children:e===i?(0,n.jsx)("span",{className:"text-[var(--warning)] text-lg font-bold",children:"●"}):(0,n.jsx)("span",{className:"text-[var(--text-muted)] text-lg",children:"○"})})]},e))]})]})]})})}let k=(0,a.forwardRef)((e,r)=>{let{className:t,variant:a="primary",size:s="md",isLoading:l,children:i,disabled:o,...c}=e;return(0,n.jsxs)("button",{ref:r,className:b("inline-flex items-center justify-center font-heading font-semibold transition-all duration-300 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-cyber-bg focus-visible:ring-cyan-400 disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden",{primary:"glass border-2 border-cyan-400/60 text-cyan-300 hover:border-cyan-400 hover:text-cyan-200 hover:shadow-glow-cyan active:scale-95",secondary:"glass border-2 border-cyan-500/40 text-white hover:border-cyan-400/60 hover:shadow-neon-cyan active:scale-95",ghost:"text-cyan-400 hover:text-cyan-300 hover:bg-cyan-900/20 border border-transparent hover:border-cyan-400/30 active:scale-95",danger:"glass border-2 border-pink-500/60 text-pink-300 hover:border-pink-400 hover:text-pink-200 hover:shadow-glow-magenta active:scale-95",success:"glass border-2 border-lime-400/60 text-lime-300 hover:border-lime-400 hover:text-lime-200 hover:shadow-glow-lime active:scale-95",warning:"glass border-2 border-purple-400/60 text-purple-300 hover:border-purple-400 hover:text-purple-200 hover:shadow-glow-purple active:scale-95"}[a],{sm:"px-3 py-1.5 text-xs h-8",md:"px-4 py-2 text-sm h-10",lg:"px-6 py-3 text-base h-12"}[s],t),disabled:o||l,...c,children:[(0,n.jsx)("div",{className:"absolute inset-0 opacity-0 hover:opacity-100 transition-opacity duration-300",children:(0,n.jsx)("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-cyan-400/20 to-transparent transform -skew-x-12 animate-scanline"})}),(0,n.jsx)("span",{className:"relative z-10",children:l?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 inline",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Loading..."]}):i})]})});function C(e){let{children:r,showSignOut:t=!0,userEmail:a}=e,l=(0,s.s0)(),i=async()=>{await d.auth.signOut(),l("/auth")};return(0,n.jsxs)("div",{className:"min-h-screen bg-[var(--bg)]",children:[(0,n.jsx)("header",{className:"sticky top-0 z-[var(--z-sticky)] border-b border-[var(--border)] bg-[var(--bg-surface)] backdrop-blur-sm",children:(0,n.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,n.jsxs)("div",{className:"flex items-center justify-between h-20",children:[(0,n.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,n.jsx)("h1",{className:"text-3xl font-bold text-[var(--text)]",children:"Game Lobby"}),a&&(0,n.jsxs)("p",{className:"text-sm text-[var(--text)]",children:["Welcome, ",a]})]}),t&&(0,n.jsxs)(k,{variant:"ghost",size:"md",onClick:i,className:"border border-[var(--danger)] text-[var(--text)] hover:bg-[var(--danger-bg)]",children:[(0,n.jsx)("svg",{className:"w-4 h-4 mr-2 text-[var(--danger)]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),"Sign Out"]})]})})}),(0,n.jsx)("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:r})]})}k.displayName="Button";let I=0,A=[],P=[],T={show:function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",t=arguments.length>2?arguments[2]:void 0,n="toast-".concat(++I);return A.push({id:n,message:e,type:r,duration:t}),P.forEach(e=>e([...A])),n},success:(e,r)=>T.show(e,"success",r),error:(e,r)=>T.show(e,"error",r),info:(e,r)=>T.show(e,"info",r),warning:(e,r)=>T.show(e,"warning",r)};function O(e){let{className:r,variant:t="rectangular",...a}=e;return(0,n.jsx)("div",{className:b("animate-pulse bg-[var(--surface)]",{text:"h-4 rounded",circular:"rounded-full",rectangular:"rounded-lg"}[t],r),...a})}function W(){let{roomId:e}=(0,s.UO)(),r=(0,s.s0)(),[t,l]=(0,a.useState)(null),[i,o]=(0,a.useState)([]),[c,g]=(0,a.useState)(null),[x,N]=(0,a.useState)(!0),[j,I]=(0,a.useState)(null),[A,P]=(0,a.useState)(!1),[W,L]=(0,a.useState)(!1),[U,D]=(0,a.useState)(!1),[M,Y]=(0,a.useState)("disconnected"),[F,Q]=(0,a.useState)([]),[z,J]=(0,a.useState)(null),q=(0,a.useRef)(null),H=(0,a.useRef)(!1),[K,G]=(0,a.useState)([]),[B,V]=(0,a.useState)(""),X=(0,a.useRef)(!0),Z=(0,a.useRef)(0),$=(0,a.useRef)(null),ee=(0,a.useRef)(null),er=(0,a.useRef)(!1),[et,en]=(0,a.useState)([]),[ea,es]=(0,a.useState)(null),[el,ei]=(0,a.useState)(null),[eo,ec]=(0,a.useState)([]),[ed,eu]=(0,a.useState)(null),em=(0,a.useRef)(null),[ey,ep]=(0,a.useState)(null),[ef,eg]=(0,a.useState)(null),[ex,eh]=(0,a.useState)([]),[ev,eb]=(0,a.useState)([]),[eS,eN]=(0,a.useState)([]),[ej,ew]=(0,a.useState)(null),[eE,eR]=(0,a.useState)(null),[e_,ek]=(0,a.useState)({}),[eC,eI]=(0,a.useState)(null),[eA,eP]=(0,a.useState)(!1),[eT,eO]=(0,a.useState)([]),[eW,eL]=(0,a.useState)(null),[eU,eD]=(0,a.useState)(60),[eM,eY]=(0,a.useState)([]),[eF,eQ]=(0,a.useState)(60),[ez,eJ]=(0,a.useState)({}),[eq,eH]=(0,a.useState)([]),eK=(0,a.useCallback)(e=>{var r;let t=i.find(r=>r.player_id===e);return(null==t?void 0:null===(r=t.profile)||void 0===r?void 0:r.display_name)?t.profile.display_name:e.length>8?"".concat(e.substring(0,8),"..."):e},[i]),eG=(0,a.useMemo)(()=>{let e={};return i.forEach(r=>{var t;let n=(null===(t=r.profile)||void 0===t?void 0:t.display_name)||"";n&&(e[r.player_id]=n)}),e},[i]),eB=(0,a.useMemo)(()=>{let e={};return i.forEach(r=>{var t;(null===(t=r.profile)||void 0===t?void 0:t.avatar_url)&&(e[r.player_id]=r.profile.avatar_url)}),e},[i]),eV=(0,a.useCallback)(async(r,n)=>{if("playing"!==r){X.current=!1;return}if(X.current=!0,q.current){let e=q.current.readyState;if(e===WebSocket.OPEN){u("[AutoConnect] Already connected, skipping");return}if(e===WebSocket.CONNECTING){u("[AutoConnect] Already connecting, skipping");return}(e===WebSocket.CLOSING||e===WebSocket.CLOSED)&&(q.current.close(),q.current=null)}if(H.current){u("[AutoConnect] Connection in progress (flag), skipping");return}u("[AutoConnect] room.status is playing");try{let{data:{session:r}}=await d.auth.getSession(),a=!!(null==r?void 0:r.access_token);if(u("[AutoConnect] token present?",a),!(null==r?void 0:r.access_token)){u("[AutoConnect] No access token available"),J("No access token available"),Y("error");return}u("[AutoConnect] creating WS"),H.current=!0,Y("connecting"),J(null),V("ws:localhost:4000/ws");let s=function(e,r,t,n,a){let s=p(),l=(e,r)=>{let t={timestamp:Date.now(),event:e,data:r};u("[WS] ".concat(e),void 0!==r?r:""),a&&a(t)};l("creating socket",{url:s});let i=new WebSocket(s),o=!1,c=null,d=!1;return c=setTimeout(()=>{i.readyState===WebSocket.OPEN||o||(l("open timeout - WS_OPEN_TIMEOUT",{readyState:i.readyState}),t({type:"WS_OPEN_TIMEOUT",error:"WebSocket open event did not fire within 5 seconds"}),i.close())},5e3),i.onopen=()=>{c&&(clearTimeout(c),c=null),l("open");try{i.send(JSON.stringify({type:"HELLO",roomId:e,accessToken:r})),o=!0,l("HELLO sent successfully")}catch(e){y("[WS] Failed to send HELLO message:",e),t({type:"WS_ERROR",error:"Failed to send HELLO message",details:e instanceof Error?e.message:String(e)})}},i.sendSyncRequest=()=>{if(i.readyState===WebSocket.OPEN)try{i.send(JSON.stringify({type:"SYNC_REQUEST",roomId:e})),l("SYNC_REQUEST sent")}catch(e){y("[WS] Failed to send SYNC_REQUEST:",e)}},i.onmessage=e=>{var r;l("message received",{dataLength:(null===(r=e.data)||void 0===r?void 0:r.length)||0});try{let r=JSON.parse(e.data);l("message parsed",{type:r.type}),"ERROR"===r.type&&y("[WS] Server ERROR message:",r),t(r)}catch(r){y("[WS] Failed to parse WebSocket message:",r),t({type:"PARSE_ERROR",error:"Failed to parse message",parseError:r instanceof Error?r.message:String(r),raw:e.data})}},i.onerror=e=>{y("[WS] WebSocket error event:",e),t({type:"WS_ERROR",error:"WebSocket connection error",details:e instanceof Error?e.message:String(e)})},i.onclose=e=>{c&&(clearTimeout(c),c=null),l("close",{code:e.code,reason:e.reason,wasClean:e.wasClean,manualClose:d}),n&&n(e.code,e.reason,e.wasClean)},i.markManualClose=()=>{d=!0},i}(n,r.access_token,r=>{if(u("[WS] message handler received",r.type),"ERROR"===r.type){let e="string"==typeof r.error?r.error:"string"==typeof r.message?r.message:"object"==typeof r.error&&null!==r.error&&"message"in r.error?String(r.error.message||"Server error"):"Server error";y("[WS] Server ERROR:",e),J(e),Y("error")}else if("WELCOME"===r.type)u("[WS] Received WELCOME"),u("[AutoConnect] WS connected because room is playing"),Y("connected"),J(null),H.current=!1,Z.current=0,setTimeout(()=>{let r=n||e;if(q.current&&q.current.readyState===WebSocket.OPEN&&r)try{if(!r||"string"!=typeof r||""===r.trim()){y("[WS] Cannot send SYNC_REQUEST: Invalid roomId",{roomId:r,type:typeof r,fromParams:e,fromConnect:n});return}let t={type:"SYNC_REQUEST",roomId:r.trim()};u("[WS] Sending SYNC_REQUEST:",t);let a=JSON.stringify(t);u("[WS] SYNC_REQUEST JSON:",a),q.current.send(a),u("[WS] SYNC_REQUEST sent")}catch(e){y("[WS] Failed to send SYNC_REQUEST:",e)}else{var t;y("[WS] Cannot send SYNC_REQUEST:",{wsReady:(null===(t=q.current)||void 0===t?void 0:t.readyState)===WebSocket.OPEN,roomId:r,roomIdFromParams:e,roomIdFromConnect:n})}},100);else if("STATE"===r.type)u("[WS] Received STATE"),u("[AutoConnect] WS connected because room is playing"),Y("connected"),J(null),H.current=!1,Z.current=0,setTimeout(()=>{let r=n||e;if(q.current&&q.current.readyState===WebSocket.OPEN&&r)try{if(!r||"string"!=typeof r||""===r.trim()){y("[WS] Cannot send SYNC_REQUEST (after STATE): Invalid roomId",{roomId:r,type:typeof r,fromParams:e,fromConnect:n});return}let t={type:"SYNC_REQUEST",roomId:r.trim()};u("[WS] Sending SYNC_REQUEST (after STATE):",t);let a=JSON.stringify(t);u("[WS] SYNC_REQUEST JSON (after STATE):",a),q.current.send(a),u("[WS] SYNC_REQUEST sent (after STATE)")}catch(e){y("[WS] Failed to send SYNC_REQUEST:",e)}else{var t;y("[WS] Cannot send SYNC_REQUEST (after STATE):",{wsReady:(null===(t=q.current)||void 0===t?void 0:t.readyState)===WebSocket.OPEN,roomId:r,roomIdFromParams:e,roomIdFromConnect:n})}},100);else if("SYNC_STATE"===r.type){if(u("[WS] Received SYNC_STATE"),eu(null),em.current=null,r.seatedPlayerIds&&Array.isArray(r.seatedPlayerIds)&&eh(r.seatedPlayerIds),r.queuePlayerIds&&Array.isArray(r.queuePlayerIds)&&eb(r.queuePlayerIds),r.currentTurnPlayerId&&"string"==typeof r.currentTurnPlayerId&&ew(r.currentTurnPlayerId),r.lastPlay&&"object"==typeof r.lastPlay&&null!==r.lastPlay){let e=r.lastPlay,t={playerId:"string"==typeof e.playerId?e.playerId:"",cards:Array.isArray(e.cards)?e.cards.map(e=>f(e)):[],kind:"string"==typeof e.kind?e.kind:void 0,fiveKind:"string"==typeof e.fiveKind?e.fiveKind:void 0};eR(t)}else eR(null);if(r.handsCount&&"object"==typeof r.handsCount&&null!==r.handsCount){let e={};for(let[t,n]of Object.entries(r.handsCount))e[t]="number"==typeof n?n:0;ek(e)}if(r.totalScores&&"object"==typeof r.totalScores){let e={};for(let[t,n]of Object.entries(r.totalScores))e[t]="number"==typeof n?n:0;eJ(e)}if(r.eliminated&&Array.isArray(r.eliminated)&&eH(r.eliminated),r.yourHand&&Array.isArray(r.yourHand)){let e=r.yourHand.map(e=>f(e)),t=h(e);ei(t),ec([])}"number"==typeof r.scoreLimit&&eD(r.scoreLimit)}else if("ROOM_STATE"===r.type){if(u("[WS] Received ROOM_STATE"),r.players&&Array.isArray(r.players)){let t=r.players;en(t.map(e=>{var r;return{playerId:e.playerId,isReady:null!==(r=e.isReady)&&void 0!==r&&r}})),o(r=>{let n=t.map(e=>e.playerId),a=new Set(r.map(e=>e.player_id)),s=n.filter(e=>!a.has(e));return s.length>0&&e&&Promise.all(s.map(async r=>{try{let{data:n}=await d.from("profiles").select("id, display_name, avatar_url").eq("id",r).single();n&&o(a=>{var s;return a.find(e=>e.player_id===r)?a.map(e=>e.player_id===r?{...e,profile:n}:e):[...a,{player_id:r,room_id:e,is_ready:(null===(s=t.find(e=>e.playerId===r))||void 0===s?void 0:s.isReady)||!1,left_at:null,joined_at:new Date().toISOString(),id:"",profile:n}]})}catch(e){m("Failed to fetch profile for player ".concat(r,":"),e)}})).catch(e=>{m("Failed to fetch profiles for new players:",e)}),r})}}else if("ROUND_START"===r.type)u("[WS] Received ROUND_START"),r.roomId&&"string"==typeof r.roomId&&r.startedAt&&"string"==typeof r.startedAt&&es({roomId:r.roomId,startedAt:r.startedAt});else if("RULES"===r.type)u("[WS] Received RULES"),"number"==typeof r.scoreLimit&&(eD(r.scoreLimit),eQ(r.scoreLimit));else if("SCORE_UPDATE"===r.type){if(u("[WS] Received SCORE_UPDATE"),r.totalScores&&"object"==typeof r.totalScores){let e=[],t={};for(let[n,a]of Object.entries(r.totalScores)){let s="number"==typeof a?a:0;t[n]=s,e.push({playerId:n,totalScore:s,eliminated:!!(r.eliminated&&Array.isArray(r.eliminated))&&r.eliminated.includes(n)})}eJ(t),eY(e),r.eliminated&&Array.isArray(r.eliminated)&&eH(r.eliminated)}}else if("DEALT"===r.type){if(u("[WS] Received DEALT"),eL(null),eu(null),em.current=null,r.yourHand&&Array.isArray(r.yourHand)){let e=r.yourHand.map(e=>f(e)),t=h(e);ei(t),eN([]),ec([])}r.starterPlayerId&&"string"==typeof r.starterPlayerId&&ep(r.starterPlayerId),r.reason&&"string"==typeof r.reason&&eg(r.reason),r.seatedPlayerIds&&Array.isArray(r.seatedPlayerIds)&&eh(r.seatedPlayerIds)}else if("GAME_STATE"===r.type){if(u("[WS] Received GAME_STATE"),r.currentTurnPlayerId&&"string"==typeof r.currentTurnPlayerId&&ew(r.currentTurnPlayerId),r.lastPlay&&"object"==typeof r.lastPlay&&null!==r.lastPlay){let e=r.lastPlay,t={playerId:"string"==typeof e.playerId?e.playerId:"",cards:Array.isArray(e.cards)?e.cards.map(e=>f(e)):[],kind:"string"==typeof e.kind?e.kind:void 0,fiveKind:"string"==typeof e.fiveKind?e.fiveKind:void 0};eR(t),t.playerId===c&&em.current&&(u("[WS] Play successful, clearing pending cards"),eu(null),em.current=null)}else eR(null);if(eN([]),r.handsCount&&"object"==typeof r.handsCount&&null!==r.handsCount){let e={};for(let[t,n]of Object.entries(r.handsCount))e[t]="number"==typeof n?n:0;ek(e)}if("boolean"==typeof r.canPass&&eP(r.canPass),r.passedPlayerIds&&Array.isArray(r.passedPlayerIds)?eO(r.passedPlayerIds):eO([]),r.queuePlayerIds&&Array.isArray(r.queuePlayerIds)&&eb(r.queuePlayerIds),r.totalScores&&"object"==typeof r.totalScores){let e={};for(let[t,n]of Object.entries(r.totalScores))e[t]="number"==typeof n?n:0;eJ(e)}r.eliminated&&Array.isArray(r.eliminated)&&eH(r.eliminated)}else if("ACTION_ERROR"===r.type){let e="string"==typeof r.error?r.error:"string"==typeof r.message?r.message:"object"==typeof r.error&&null!==r.error&&"message"in r.error?String(r.error.message||"Action error"):"Action error";y("[WS] Received ACTION_ERROR:",e),eI(e);let t=em.current;t&&t.length>0&&(u("[WS] Restoring cards after ACTION_ERROR:",t),ei(e=>{if(!e)return e;let r=[...e,...t];return h(r)}),ec([]),eu(null),em.current=null),setTimeout(()=>eI(null),5e3)}else if("ROUND_END"===r.type)u("[WS] Received ROUND_END"),r.winnerPlayerId&&"string"==typeof r.winnerPlayerId&&eL({winnerPlayerId:r.winnerPlayerId});else if("WS_ERROR"===r.type||"PARSE_ERROR"===r.type){let e="string"==typeof r.error?r.error:"object"==typeof r.error&&null!==r.error&&"message"in r.error?String(r.error.message||"WebSocket error"):"WebSocket error";y("[WS] Client error:",e),J(e),Y("error"),H.current=!1}else if("WS_OPEN_TIMEOUT"===r.type){let e="string"==typeof r.error?r.error:"object"==typeof r.error&&null!==r.error&&"message"in r.error?String(r.error.message||"WebSocket open timeout"):"WebSocket open timeout";y("[WS] Open timeout:",e),J(e),Y("error"),H.current=!1}},(e,r,n)=>{u("[WS] close handler: code=".concat(e,", reason=").concat(r,", wasClean=").concat(n)),q.current=null,H.current=!1;let a=null==t?void 0:t.status;if(X.current&&"playing"===a&&!n){let e=[500,1e3,2e3,4e3,8e3],r=async n=>{let a=null==t?void 0:t.status,s=null==t?void 0:t.id;if(!X.current||"playing"!==a||!s){Y("disconnected");return}if(n>10){Y("disconnected"),J("Failed to reconnect after 10 attempts"),u("[Reconnect] Max attempts reached, giving up");return}let l=Math.min(n-1,e.length-1),i=e[l];Z.current=n,Y("reconnecting"),u("[Reconnect] Attempt ".concat(n," in ").concat(i,"ms")),setTimeout(async()=>{let e=null==t?void 0:t.status,a=null==t?void 0:t.id;if(!X.current||"playing"!==e||!a){Y("disconnected");return}if(q.current){let e=q.current.readyState;if(e===WebSocket.OPEN||e===WebSocket.CONNECTING){u("[Reconnect] Already connected/connecting, skipping");return}}await eV(e,a),setTimeout(()=>{X.current&&(null==t?void 0:t.status)==="playing"&&(!q.current||q.current.readyState!==WebSocket.OPEN)&&r(n+1)},i+1e3)},i)};r(1)}else Y("disconnected")},e=>{});q.current=s}catch(r){let e=r instanceof Error?r.message:"Failed to connect to game server";y("[AutoConnect] Connection error:",r),J(e),Y("error"),q.current=null,H.current=!1}},[]);(0,a.useEffect)(()=>{if(!e){r("/lobby");return}if(er.current){u("[RoomsRT] Channel setup already in progress, skipping");return}let t=$.current,n=ee.current;if(t&&n){let e=null==t?void 0:t.state,r=null==n?void 0:n.state;if("joined"===e||"joining"===e||"joined"===r||"joining"===r){u("[RoomsRT] Channels already exist and active, skipping creation");return}("closed"===e||"errored"===e||"closed"===r||"errored"===r)&&(u("[RoomsRT] Cleaning up closed/errored channels"),d.removeChannel(t),d.removeChannel(n),$.current=null,ee.current=null)}er.current=!0,(async()=>{try{let{data:{user:t}}=await d.auth.getUser();if(!t){r("/auth");return}g(t.id);let{data:n,error:a}=await d.from("rooms").select("*").eq("id",e).single();if(a||!n)throw Error("Room not found");l(n),await eX(e),ee.current&&(d.removeChannel(ee.current),ee.current=null),$.current&&(d.removeChannel($.current),$.current=null);let s=d.channel("room_players:".concat(e)).on("postgres_changes",{event:"*",schema:"public",table:"room_players",filter:"room_id=eq.".concat(e)},()=>{eX(e)}).subscribe();ee.current=s;let i="room:".concat(e),o="id=eq.".concat(e);u("[RoomsRT] Creating channel:",i),u("[RoomsRT] Filter:",o);let c=d.channel(i).on("postgres_changes",{event:"UPDATE",schema:"public",table:"rooms",filter:o},r=>{if(u("[RoomsRT] payload received"),r.new){let t=r.new;l(e=>e&&e.id===t.id&&e.status===t.status&&e.score_limit===t.score_limit?e:t),"playing"===t.status&&(u("[AutoConnect] Realtime: room status updated to playing"),eV(t.status,e))}}).subscribe(e=>{u("[RoomsRT] Subscribe status:",e),"SUBSCRIBED"===e?u("[RoomsRT] Successfully subscribed to room updates"):"TIMED_OUT"===e?m("[RoomsRT] Subscription timed out"):"CHANNEL_ERROR"===e?(y("[RoomsRT] Channel error occurred"),$.current===c&&($.current=null)):"CLOSED"===e&&(u("[RoomsRT] Channel closed"),$.current===c&&($.current=null))});return $.current=c,u("[AutoConnect] Initial fetch: room.status =",n.status),eV(n.status,e),er.current=!1,()=>{er.current=!1,ee.current&&(d.removeChannel(ee.current),ee.current=null),$.current&&(d.removeChannel($.current),$.current=null),q.current&&(q.current.close(),q.current=null),H.current=!1}}catch(e){er.current=!1,e instanceof Error?I(e.message):I("Failed to load room")}finally{N(!1)}})()},[e]),(0,a.useEffect)(()=>{(null==t?void 0:t.score_limit)&&(eD(t.score_limit),eQ(t.score_limit))},[null==t?void 0:t.score_limit]),(0,a.useEffect)(()=>{if(!e||!t||!("connected"!==M&&"connecting"!==M&&"playing"!==t.status))return;u("[Polling] Starting fallback polling for room status");let r=setInterval(async()=>{try{let{data:t,error:n}=await d.from("rooms").select("status").eq("id",e).single();if(n){y("[Polling] Error fetching room status:",n);return}(null==t?void 0:t.status)==="playing"&&(u("[Polling] Room status changed to playing, connecting WS"),eV("playing",e),clearInterval(r))}catch(e){y("[Polling] Polling error:",e)}},1e3);return()=>{u("[Polling] Stopping fallback polling"),clearInterval(r)}},[e,M,eV]);let eX=async e=>{try{let{data:r,error:t}=await d.from("room_players").select("*").eq("room_id",e).is("left_at",null),n=r;if(t){m("Query with .is() failed, trying alternative approach:",t);let{data:r,error:a}=await d.from("room_players").select("*").eq("room_id",e);if(a){y("Failed to fetch players:",a);let e=(null==a?void 0:a.message)||String(a);I("Failed to load players: ".concat(e));return}n=(null==r?void 0:r.filter(e=>null===e.left_at))||null}if(!n||0===n.length){o([]);return}let a=await Promise.all(n.map(async e=>{let{data:r,error:t}=await d.from("profiles").select("id, display_name, avatar_url").eq("id",e.player_id).single();return t&&m("Failed to fetch profile for player ".concat(e.player_id,":"),t),{...e,profile:r}}));o(a)}catch(e){y("Error in fetchPlayers:",e),I(e instanceof Error?e.message:"Failed to fetch players")}},eZ=(0,a.useCallback)(r=>{if(!e||!q.current||q.current.readyState!==WebSocket.OPEN)return m("[READY] Cannot send READY: WS not connected"),!1;try{return u("[READY] Sending READY message"),q.current.send(JSON.stringify({type:"READY",roomId:e,isReady:r})),!0}catch(e){return y("[READY] Failed to send READY message:",e),!1}},[e]),e$=(0,a.useCallback)(r=>{if(!e||!q.current||q.current.readyState!==WebSocket.OPEN)return m("[PLAY] Cannot send PLAY: WS not connected"),!1;try{return u("[PLAY] Sending PLAY message"),q.current.send(JSON.stringify({type:"PLAY",roomId:e,cards:r})),eI(null),eu(r),em.current=r,ei(e=>{if(!e)return e;let t=e.filter(e=>!r.some(r=>v(r,e)));return t=h(t),ec(t=>{if(0===t.length)return[];let n=new Set(r.map(r=>e.findIndex(e=>v(e,r))).filter(e=>-1!==e));return t.filter(e=>!n.has(e)).map(e=>{let r=Array.from(n).filter(r=>r<e).length;return e-r})}),t}),eN([]),!0}catch(e){return y("[PLAY] Failed to send PLAY message:",e),eI("Failed to send play message"),!1}},[e]),e0=(0,a.useCallback)(r=>{if(!e||!q.current||q.current.readyState!==WebSocket.OPEN)return m("[SET_RULES] Cannot send SET_RULES: WS not connected"),!1;try{return u("[SET_RULES] Sending SET_RULES message"),q.current.send(JSON.stringify({type:"SET_RULES",roomId:e,scoreLimit:r})),eI(null),!0}catch(e){return y("[SET_RULES] Failed to send SET_RULES message:",e),eI("Failed to set rules"),!1}},[e]),e1=(0,a.useCallback)(()=>{if(!e||!q.current||q.current.readyState!==WebSocket.OPEN)return m("[PASS] Cannot send PASS: WS not connected"),!1;try{return u("[PASS] Sending PASS message"),q.current.send(JSON.stringify({type:"PASS",roomId:e})),eI(null),!0}catch(e){return y("[PASS] Failed to send PASS message:",e),eI("Failed to send pass message"),!1}},[e]),e2=e=>{eN(r=>r.some(r=>r.rank===e.rank&&r.suit===e.suit)?r.filter(r=>!(r.rank===e.rank&&r.suit===e.suit)):r.length>=5?r:[...r,e])},e4=ej===c,e3=async()=>{var r,t;if(e&&c&&!A){if("connected"===M&&(null===(r=q.current)||void 0===r?void 0:r.readyState)===WebSocket.OPEN){let e=et.find(e=>e.playerId===c),r=i.find(e=>e.player_id===c),n=e?e.isReady:null!==(t=null==r?void 0:r.is_ready)&&void 0!==t&&t;P(!0),eZ(!n)||I("Failed to send ready status. Please try again."),P(!1);return}P(!0);try{let r=i.find(e=>e.player_id===c);if(!r)return;let{error:t}=await d.from("room_players").update({is_ready:!r.is_ready}).eq("room_id",e).eq("player_id",c);if(t)throw t}catch(e){e instanceof Error&&I(e.message)}finally{P(!1)}}},e5=async()=>{if(e&&c&&!W){L(!0);try{if(X.current=!1,q.current){let e=q.current;e.markManualClose&&e.markManualClose(),q.current.close(),q.current=null}H.current=!1,Y("disconnected");let{error:t}=await d.from("room_players").update({left_at:new Date().toISOString()}).eq("room_id",e).eq("player_id",c);if(t)throw t;r("/lobby")}catch(e){e instanceof Error&&I(e.message)}finally{L(!1)}}},e6=async r=>{if(null==r||r.preventDefault(),u("[Start] clicked"),U){u("[Start] Already starting, ignoring duplicate click");return}if(!e||!c){u("[Start] Missing roomId or currentUserId",{roomId:e,currentUserId:c}),I("Missing room ID or user ID");return}u("[Start] roomId",e),D(!0);try{let{data:{session:r}}=await d.auth.getSession(),t=!!(null==r?void 0:r.access_token);if(u("[Start] session token present?",t),!(null==r?void 0:r.access_token)){I("No access token available. Please log in again."),J("No access token available");return}let{data:n,error:a}=await d.from("rooms").select("id, owner_id, status").eq("id",e).single();if(a||!n){let e=(null==a?void 0:a.message)||"Room not found";y("[Start] room fetch error:",a),I("Failed to fetch room: ".concat(e)),J("Failed to fetch room: ".concat(e));return}if(c!==n.owner_id){let e="Only the room owner can start the game";u("[Start] Ownership check failed",{currentUserId:c,ownerId:n.owner_id}),I(e),J(e);return}if("playing"===n.status){u("[Start] Room already playing, skipping PATCH"),D(!1);return}u("[Start] Patching rooms.status to 'playing'");let{error:s}=await d.from("rooms").update({status:"playing"}).eq("id",e);if(s){let e={status:(null==s?void 0:s.status)||"unknown",message:s.message||"Unknown error",details:(null==s?void 0:s.details)||null,hint:(null==s?void 0:s.hint)||null};y("[Start] patch rooms.status result ERROR:",e);let r="Failed to update room status: ".concat(e.message).concat(e.hint?" (".concat(e.hint,")"):"");I(r),J(r),D(!1);return}u("[Start] patch rooms.status result SUCCESS");let l=setTimeout(()=>{D(!1)},5e3),i=setInterval(()=>{("connected"===M||"error"===M)&&(clearInterval(i),clearTimeout(l),D(!1))},100);setTimeout(()=>{clearInterval(i)},1e4)}catch(r){let e=r instanceof Error?r.message:"Failed to start game";y("[Start] Unexpected error:",r),I(e),J(e),D(!1)}},e9=async()=>{e&&c&&t&&(q.current&&(q.current.close(),q.current=null),H.current=!1,await eV(t.status,t.id))};if(x)return(0,n.jsx)(C,{children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-[60vh]",children:(0,n.jsxs)("div",{className:"space-y-4 w-full max-w-md",children:[(0,n.jsx)(O,{className:"h-12 w-full"}),(0,n.jsx)(O,{className:"h-10 w-3/4"}),(0,n.jsx)(O,{className:"h-10 w-full"})]})})});if(j||!t)return(0,n.jsx)(C,{children:(0,n.jsx)("div",{className:"space-y-4",children:(0,n.jsx)(R,{children:(0,n.jsxs)("div",{className:"p-6 text-center space-y-4",children:[(0,n.jsx)("p",{className:"text-[var(--danger)]",children:j||"Room not found"}),(0,n.jsx)(k,{onClick:()=>r("/lobby"),children:"Back to Lobby"})]})})})});let e8=i.find(e=>e.player_id===c),e7=c===t.owner_id;return(0,n.jsx)(C,{title:"Room: ".concat(t.code),subtitle:"Score Limit: ".concat(eU),showSignOut:!1,children:(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsx)("div",{className:"flex justify-end",children:(0,n.jsx)(k,{variant:"danger",onClick:e5,disabled:W,isLoading:W,children:"Leave Room"})}),j&&(0,n.jsx)("div",{className:"p-4 bg-[var(--danger-bg)] border border-[var(--danger)] text-[var(--danger)] rounded-lg",children:j}),ea&&(0,n.jsx)("div",{className:"p-4 bg-[var(--success)] text-white rounded-lg shadow-md",children:(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("strong",{className:"text-lg",children:"Round starting..."}),(0,n.jsx)("span",{className:"text-sm opacity-90",children:new Date(ea.startedAt).toLocaleString()})]})}),el&&(0,n.jsx)("div",{className:"p-4 bg-[var(--info)] text-white rounded-lg shadow-md text-center font-semibold",children:"Cards dealt. Waiting for starter..."}),!1,(0,n.jsx)(R,{children:(0,n.jsxs)(R,{header:(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("h3",{className:"text-base font-semibold text-[var(--text)]",children:"Game Server Connection"}),(0,n.jsxs)(S,{variant:"connected"===M?"success":"connecting"===M||"reconnecting"===M?"warning":"error"===M?"danger":"default",children:["connected"===M&&"● Connected","connecting"===M&&"● Connecting...","reconnecting"===M&&"● Reconnecting (".concat(Z.current,"/10)..."),"error"===M&&"● Error","disconnected"===M&&"○ Disconnected"]})]}),children:[z&&(0,n.jsx)("div",{className:"mb-4 p-3 bg-[var(--danger-bg)] border border-[var(--danger)] text-[var(--danger)] rounded-lg text-sm",children:z}),!1,"disconnected"===M&&(null==t?void 0:t.status)==="playing"&&(0,n.jsx)(k,{size:"sm",onClick:e9,children:"Reconnect"}),!1,!1]})}),(0,n.jsx)(R,{children:(0,n.jsx)(R,{header:(0,n.jsxs)("h2",{className:"text-lg font-semibold text-[var(--text)]",children:["Players (",et.length>0?et.length:i.length,")"]}),children:(0,n.jsx)("div",{className:"space-y-3",children:(()=>{let e=i.map(e=>{var r,t;let n=et.find(r=>r.playerId===e.player_id);return{playerId:e.player_id,isReady:null!==(t=null==n?void 0:n.isReady)&&void 0!==t?t:e.is_ready,displayName:(null===(r=e.profile)||void 0===r?void 0:r.display_name)||null}});return(et.length>0&&et.forEach(r=>{e.find(e=>e.playerId===r.playerId)||e.push({playerId:r.playerId,isReady:r.isReady,displayName:null})}),0===e.length)?(0,n.jsx)("p",{className:"text-center text-[var(--text-muted)] py-8",children:"No players in room"}):e.map(e=>{let r=e.playerId===c,a=eT.includes(e.playerId),s=e.playerId===ej,l=e.displayName||eK(e.playerId);return(0,n.jsxs)("div",{className:b("flex justify-between items-center p-4 rounded-lg border transition-all",r&&"bg-[var(--primary-bg)] border-[var(--primary)]",s&&"bg-[var(--warning-bg)] border-[var(--warning)]",!r&&!s&&"bg-[var(--bg-elevated)] border-[var(--border)] hover:bg-[var(--surface-hover)]"),children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("span",{className:"font-medium text-[var(--text)]",children:l}),e7&&e.playerId===t.owner_id&&(0,n.jsx)(S,{variant:"warning",size:"sm",children:"Owner"}),a&&(0,n.jsx)(S,{variant:"default",size:"sm",children:"Passed"})]}),(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[e.isReady?(0,n.jsx)(S,{variant:"success",size:"sm",children:"✓ Ready"}):(0,n.jsx)("span",{className:"text-sm text-[var(--text-muted)]",children:"Not Ready"}),s&&(0,n.jsx)(S,{variant:"warning",size:"sm",children:"• Your Turn"})]})]},e.playerId)})})()})})}),(0,n.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4 items-center justify-center",children:[c&&(()=>{var e;let r=et.find(e=>e.playerId===c),t=r?r.isReady:null!==(e=null==e8?void 0:e8.is_ready)&&void 0!==e&&e,a=A||"connected"!==M||!!ea;return(0,n.jsx)(k,{onClick:e3,variant:t?"success":"secondary",disabled:a,isLoading:A,title:"connected"!==M?"Connect first":ea?"Round already started":"",children:"connected"!==M?"Connect first":ea?"Round started":t?"Mark Not Ready":"Mark Ready"})})(),e7&&"playing"!==t.status&&!ea&&(0,n.jsxs)("div",{className:"flex items-center gap-3 p-4 bg-[var(--bg-elevated)] rounded-lg border border-[var(--border)]",children:[(0,n.jsx)("label",{htmlFor:"scoreLimit",className:"text-sm font-medium text-[var(--text)]",children:"Score Limit (1-60):"}),(0,n.jsx)("input",{id:"scoreLimit",type:"number",min:"1",max:"60",value:eF,onChange:e=>eQ(Math.min(60,Math.max(1,Number(e.target.value)||60))),className:"w-20 px-3 py-2 bg-[var(--bg-surface)] border border-[var(--border)] rounded-lg text-[var(--text)] focus:outline-none focus:ring-2 focus:ring-[var(--border-focus)]"}),(0,n.jsx)(k,{size:"sm",onClick:()=>{eF>=1&&eF<=60&&(e0(eF),T.success("Score limit updated"))},disabled:"connected"!==M||eF<1||eF>60,title:"connected"!==M?"WebSocket disconnected":"",children:"Set Rules"})]}),e7&&"playing"!==t.status&&!ea&&(0,n.jsx)(k,{onClick:e6,disabled:U,isLoading:U,children:"Start Game"})]}),el&&(null==t?void 0:t.status)==="playing"&&(0,n.jsxs)("div",{className:"space-y-6",children:[eW&&(0,n.jsx)("div",{className:"p-4 bg-[var(--success)] text-white rounded-lg shadow-md text-center",children:(0,n.jsxs)("strong",{className:"text-lg",children:["Round ended. Winner: ",eW.winnerPlayerId]})}),eC&&(0,n.jsx)("div",{className:"p-3 bg-[var(--danger-bg)] border border-[var(--danger)] text-[var(--danger)] rounded-lg text-sm font-medium",children:eC}),(0,n.jsxs)("div",{className:"flex flex-col lg:flex-row gap-6 justify-center",children:[(0,n.jsx)("div",{className:"flex-1 min-w-0",children:(0,n.jsx)(E,{seatedPlayerIds:ex,handsCount:e_,totalScores:ez,scoreLimit:eU,currentTurnPlayerId:ej,eliminated:eq,currentUserId:c,lastPlay:eE,playerNames:eG,playerAvatars:eB})}),(0,n.jsx)("div",{className:"lg:w-80",children:(0,n.jsx)(_,{queuePlayerIds:ev,seatedPlayerIds:ex,handsCount:e_,totalScores:ez,scoreLimit:eU,currentTurnPlayerId:ej,eliminated:eq,playerNames:eG})})]}),(0,n.jsx)(R,{children:(0,n.jsxs)("div",{className:"space-y-5",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsxs)("h3",{className:"text-lg font-heading font-bold text-cyan-300 text-glow-cyan",children:["Your Hand (",el.length," cards)",eS.length>0&&(0,n.jsxs)("span",{className:"ml-2 text-sm text-lime-400 text-glow-lime font-medium",children:["• Selected: ",eS.length,"/5"]})]}),eo.length>0&&(0,n.jsx)(k,{onClick:()=>ec([]),variant:"secondary",size:"sm",title:"Sort cards by rank and suit",children:"Sort"})]}),(0,n.jsx)("div",{className:"flex flex-wrap gap-3 justify-center",children:(eo.length>0&&eo.length===el.length?eo.map(e=>el[e]).filter(Boolean):h(el)).map(e=>{let r=eS.some(r=>v(r,e)),t=el.findIndex(r=>v(r,e));return(0,n.jsx)("div",{draggable:!0,onDragStart:e=>{e.dataTransfer.setData("cardIndex",String(t)),e.dataTransfer.effectAllowed="move"},onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},onDrop:e=>{e.preventDefault();let r=parseInt(e.dataTransfer.getData("cardIndex"),10);r!==t&&ec(e=>{if(0===e.length)return el.map((e,r)=>r);let n=[...e],a=n.indexOf(r),s=n.indexOf(t);return n.splice(a,1),n.splice(s,0,r),n})},className:"cursor-move transition-transform duration-200 hover:scale-110",children:(0,n.jsx)(w,{card:e,isSelected:r,onClick:()=>e2(e),size:"md"})},"".concat(e.rank,"-").concat(e.suit,"-").concat(t))})})]}),!eW&&(0,n.jsxs)("div",{className:"flex gap-4 justify-center pt-2",children:[(0,n.jsxs)(k,{onClick:()=>{[1,2,3,5].includes(eS.length)&&e$(eS)},variant:"success",disabled:![1,2,3,5].includes(eS.length)||!e4||"connected"!==M,title:"connected"!==M?"WebSocket disconnected":e4?0===eS.length?"Select 1, 2, 3, or 5 cards to play":4===eS.length?"4 cards not allowed. Select 1, 2, 3, or 5 cards":eS.length>5?"Maximum 5 cards allowed":"":"Not your turn",children:["PLAY ",eS.length>0&&"(".concat(eS.length,")")]}),(0,n.jsx)(k,{onClick:()=>{e1()},variant:"warning",disabled:!e4||!eE||"connected"!==M,title:"connected"!==M?"WebSocket disconnected":e4?eE?"":"You must start the trick":"Not your turn",children:"PASS"})]})]})})]})]})})}function L(){return(0,n.jsx)(W,{})}},6994:function(e,r,t){"use strict";t.d(r,{UO:function(){return l},s0:function(){return s}});var n=t(9376),a=t(2265);function s(){let e=(0,n.useRouter)();return(r,t)=>{(null==t?void 0:t.replace)?e.replace(r):e.push(r)}}function l(){let e=(0,n.useParams)();return(0,a.useMemo)(()=>{let r={};return e&&Object.entries(e).forEach(e=>{let[t,n]=e;r[t]=Array.isArray(n)?n[0]:n}),r},[e])}}},function(e){e.O(0,[639,971,117,744],function(){return e(e.s=2749)}),_N_E=e.O()}]);